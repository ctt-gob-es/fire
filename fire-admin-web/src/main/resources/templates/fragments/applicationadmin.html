<!DOCTYPE html>
<div class="container-fluid">
	<h4 class="c-grey-900 mT-10 mB-30" th:text="#{app.admin.title}"></h4>
	<div class="row">
		<div class="col-md-12">
			<div class="bgc-white bd bdrs-3 p-20 mB-20">
				<h4 class="c-grey-900 mB-20" th:text="#{table.app.title}"></h4>
				<table id="appTable" class="table table-striped table-bordered" 
					cellspacing="0" width="100%">
					<thead>
						<tr>
							<!-- Columna oculta para el identificador de las aplicaciones -->
							
							<th th:text="#{table.app.name}"></th>
							<th th:text="#{table.app.id}"></th>
							
							<th th:text="#{table.app.fec_alt}"></th>
							<th th:text="#{table.app.estado}"></th>
						</tr>
					</thead>
				</table>
			</div>
		</div>
	</div>
</div>


<script th:inline="javascript">
$(document).ready(function() {
    
    var getapps = /*[[@{/applicationdatatable}]]*/;
    var actionDelete = /*[[@{/deleteapp}]]*/;
    var addTemplate = /*[[@{/addapp}]]*/;
    var tblapp = $('#appTable').DataTable({
        dom: 'Bfrtip',
        select: 'single',
        responsive: true,
        altEditor: true,
        buttons: [{text: 'Agregar',name: 'add'}, 
                  {extend: 'selected',text: 'Editar',name: 'editt',
                    action: function ( e, dt, node, config ) {                          
                      for (var o = dt, a = [], e = 0; e < o.context[0].aoColumns.length; e++) a.push({
                        id: o.context[0].aoColumns[e].mData,
                        title: o.context[0].aoColumns[e].sTitle                
                      });
                  
                  var d = dt.rows({
                   selected: !0
                  });
                  var name = d.data()[0][a[1].id];
                  var menuEdit = /*[[@{/menuedit}]]*/;
                  $.ajax({
                         url : menuEdit,
                         type : 'GET',
                         data : $.param({'appName':name}),
                         cache : false,
                         success : function(data) {
                             hide();
                             $('#modal').html(data);
                             $('#modalEdit').modal('show');                                                                
                         },
                         error : function() {}
                     });
                   }
                  },
                  {extend: 'selected',text: 'Eliminar',name: 'delete'}
                ],
        "iTotalRecords": "totalElements",
        "iTotalDisplayRecords": "numberOfElements",        
        "processing": true,
        "serverSide": true,
        "ajax": {
            "url": getapps,
            "dataSrc" : "data",
            "data": function (data) {
                // Datos a pasar al modal
                data.formId = "appForm";
                data.addTemplate = addTemplate;
            }
        },
        "language": {
            "url": "js/datatables/i18n/spanish.json",
            select: {
                rows: {
                    _: "%d filas seleccionadas",
                    1: "1 fila seleccionada"
                }
              }
            },
           
        "columns": [
              { "data": "appName" },
              { "data": "appId"},
              
            { "data": "fechaAltaApp" },
            { "data": "habilitado" }
            ]
        }).on('crudaction', function(e, accion, idUserFire, data, rowindex){
            // e          Evento Jquery
            // accion     [add|edit|delete]
            // pkid       Primer campo en la data [id]                ... en add,    retorna null
            // data       Los campos adicionales  [campo_1, campo_n]  ... en delete, retorna null
            // rowindex   El index de la fila para el dataTable       ... en add,    retorna null
            
            $('#altEditor-modal .modal-body .alert').remove();
            // Se muestra la capa 'cargando...'
            loading();
            
            
            switch(accion){
	        case 'add':
	        	if ($('#appForm')[0].checkValidity() === false) {
	        		// Se oculta la capa 'cargando...'
	        		hide();
	                event.stopPropagation();
	                
	                $('#appForm *').filter(':input').each(function(){
	            	    		            	    
	                	if(!$(this)[0].checkValidity())
	            	    {
	            	  	 $("#invalid-" + $(this).attr('id')).html();
	            	  	 $("#" + $(this).attr('id')).addClass("is-invalid");
	            	    } else {
	            	  	 $("#" + $(this).attr('id')).removeClass("is-invalid");
	            	    }
	            	    
	            	});
	                
	                // Esto es necesario para forzar que se muestren mensajes de validaciĂ³n de cliente
	                $('<input type="submit">').hide().appendTo($('#appForm')).click().remove();
	            }
	            break;
	        case 'delete':
	            $.ajax(actionDelete,{
	            	data:$.param({'id':data.appId, 'index':rowindex}),
	                type:'POST',
	                success: function(data){
	                    
	                	// Se oculta la capa 'cargando...'
	                	hide();
	                    tbl.row(data.index).remove().draw();
	                    
	                    $('#altEditor-modal .modal-body .alert').remove();
	                    $('#altEditor-modal').modal('hide');
	                },
	                error:function(){}
	            });
	            break;
	        default:
	            $('#altEditor-modal .modal-body .alert').remove();
	            $('#altEditor-modal .modal-body').append('<div class="alert alert-danger" role="alert"><strong>' + [[#{alarm.admin.error.NotAuthorized}]] + '</strong></div>');
	            break;
	    }
            
        });
    
//     var newAppList = [];
//     var responsablesText = "";
// 	for (j = 0; j < newAppList[i].nombre_responsable.length; j++){
		
// 		responsablesText = responsablesText + dataUndefined(newAppList[i].nombre_responsable[j]);
// 		if (j < newAppList[i].nombre_responsable.length - 1) {
// 			responsablesText = responsablesText + "</br>";
// 		}
// 	}
	
//     var htmlTableBody = "";
    
//     htmlTableBody = htmlTableBody + responsablesText + "</td>";
// 	htmlTableBody = htmlTableBody + "<td>" + newAppList[i].alta + "</td>";
// 	if (newAppList[i].habilitado){  
// 		htmlTableBody = htmlTableBody + '<td title="' + dataUndefined(newAppList[i].habilitado) + '"><img  class = "habilitado" src="../resources/static/images/comprobado_icon.png"/></td>'
// 	} else {
// 		htmlTableBody = htmlTableBody + '<td title="' + dataUndefined(newAppList[i].habilitado) + '"><img  class = "deshabilitado" src="../resources/static/images/sin_entrada_icon.png"/></td>'
// 	}


 

 

});
</script>